# 认证模态框系统

## 概述

项目已升级为更友好的认证体验：
- ❌ 旧方式：遇到 401 错误直接跳转到登录页面，数据丢失
- ✅ 新方式：弹出精美的登录/注册模态框，登录后保持页面状态

## 功能特点

### 1. 精美的双栏设计
- **左侧**：展示 PixelDraw 的用户权益
  - 免费积分（注册送 20 积分）
  - 智能工具介绍
  - 数据保存保障
  - 安全性说明

- **右侧**：登录/注册表单
  - 标签切换（注册/登录）
  - 集成 Clerk 认证组件
  - 响应式设计

### 2. 自动触发机制
当用户在未登录状态下尝试使用需要认证的功能时：
- 自动弹出认证模态框
- 无需手动跳转
- 不会丢失当前操作

### 3. 无缝登录体验
- 登录成功后自动关闭模态框
- 页面状态完全保持
- 用户可立即继续之前的操作

## 技术实现

### 文件结构
```
components/
  auth-modal.tsx              # 认证模态框组件
contexts/
  auth-modal-context.tsx      # 全局状态管理
lib/
  api.ts                       # API 请求封装（自动处理 401）
app/
  layout.tsx                   # 添加了 AuthModalProvider
```

### 使用方式

#### 1. 自动触发（推荐）
所有使用 `lib/api.ts` 中函数的 API 调用都会自动处理：

```typescript
import { apiGet, apiPost } from '@/lib/api';

// 如果未登录，会自动弹出认证模态框
const response = await apiGet('/api/user-credits');
const response = await apiPost('/api/compress', formData);
```

#### 2. 手动触发
在特殊情况下，也可以手动触发：

```typescript
import { showAuthModal } from '@/contexts/auth-modal-context';

// 手动显示认证模态框
showAuthModal();
```

## 错误消息优化

所有不友好的错误提示已更新：
- ❌ "未授权"、"用户未认证"
- ✅ "请先登录"、"请登录后继续操作"

## 注意事项

1. **保持页面状态**：登录时使用 `routing="virtual"`，避免页面刷新
2. **自动关闭**：监听 `isSignedIn` 状态，登录成功后 0.5 秒自动关闭
3. **全局事件**：使用自定义事件 `show-auth-modal` 实现跨组件通信

## 测试方法

1. 访问任何需要登录的功能（如积分历史）
2. 确保处于未登录状态
3. 点击操作按钮
4. 应弹出认证模态框而非跳转

## 效果展示

### 登录前
```
用户点击"查看积分历史" → 自动弹出认证模态框 → 展示权益和登录表单
```

### 登录后
```
用户完成登录 → 模态框自动关闭 → 页面状态保持 → 可立即继续操作
```

## 权益说明

认证模态框左侧展示的用户权益：
- 🎁 注册即送 20 积分
- ⚡ 四大智能工具（压缩、抠图、识别、生图）
- 👑 任务记录永久保存
- 🛡️ 企业级安全保障
